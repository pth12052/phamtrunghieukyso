<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ng∆∞·ªùi nh·∫≠n</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        #drop-area-verify {
            border: 2px dashed #aaa;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #drop-area-verify.highlight {
            background-color: #e0f7fa;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Ng∆∞·ªùi Nh·∫≠n: Nh·∫≠n File ƒê√£ K√Ω S·ªë</h1>

    <div class="result">
        <h2>Ch·ªØ k√Ω nh·∫≠n ƒë∆∞·ª£c:</h2>
        <textarea id="received-signature" rows="6" readonly></textarea>

        <h2>Public Key nh·∫≠n ƒë∆∞·ª£c:</h2>
        <textarea id="received-pubkey" rows="10" readonly></textarea>

        <h2>N·ªôi dung file nh·∫≠n ƒë∆∞·ª£c:</h2>
        <textarea id="received-data" rows="6" readonly></textarea>

        <input type="hidden" id="received-data-type">
    </div>

    <hr>

    <div class="verify">
        <h2>üîç X√°c minh file ƒë∆∞·ª£c g·ª≠i</h2>
        <div id="drop-area-verify">
            <p>K√©o th·∫£ ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file c·∫ßn x√°c minh</p>
            <input type="file" id="verifyFileInput" style="display: none;" />
            <p id="verify-file-name" style="font-weight: bold;"></p>
        </div>
        <button id="verifyButton">‚úÖ X√°c minh file</button>
        <div id="verify-result" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();

    socket.on('new_signature', function(data) {
        document.getElementById('received-signature').value = data.signature;
        document.getElementById('received-pubkey').value = data.pub_key;
        document.getElementById('received-data').value = data.data;
        document.getElementById('received-data-type').value = data.data_type || 'text';
        alert("üîê ƒê√£ nh·∫≠n ƒë∆∞·ª£c ch·ªØ k√Ω, public key v√† n·ªôi dung file!");
    });

    const fileInput = document.getElementById('verifyFileInput');
    const dropVerify = document.getElementById('drop-area-verify');
    const fileNameDisplay = document.getElementById('verify-file-name');
    const verifyResult = document.getElementById('verify-result');
    let selectedFile = null;

    dropVerify.addEventListener('click', () => fileInput.click());

    dropVerify.addEventListener('dragover', e => {
        e.preventDefault();
        dropVerify.classList.add('highlight');
    });

    dropVerify.addEventListener('dragleave', () => {
        dropVerify.classList.remove('highlight');
    });

    dropVerify.addEventListener('drop', e => {
        e.preventDefault();
        dropVerify.classList.remove('highlight');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            selectedFile = files[0];
            fileInput.files = files;
            fileNameDisplay.textContent = `üìÑ File ƒë√£ ch·ªçn: ${selectedFile.name}`;
        }
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            fileNameDisplay.textContent = `üìÑ File ƒë√£ ch·ªçn: ${selectedFile.name}`;
        }
    });

    document.getElementById('verifyButton').addEventListener('click', () => {
        if (!selectedFile) {
            verifyResult.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn ho·∫∑c k√©o m·ªôt file v√†o tr∆∞·ªõc.";
            verifyResult.style.color = "orange";
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const fileBuffer = new Uint8Array(e.target.result);
            const receivedData = document.getElementById('received-data').value.trim();
            const dataType = document.getElementById('received-data-type').value;

            if (dataType === 'base64') {
                const fileBase64 = btoa(String.fromCharCode(...fileBuffer));
                if (fileBase64 === receivedData) {
                    verifyResult.textContent = "‚úÖ File tr√πng kh·ªõp (base64)";
                    verifyResult.style.color = "green";
                } else {
                    verifyResult.textContent = "‚ùå File kh√¥ng kh·ªõp (base64)";
                    verifyResult.style.color = "red";
                }
            } else {
                const fileText = new TextDecoder().decode(fileBuffer).trim();
                if (fileText === receivedData) {
                    verifyResult.textContent = "‚úÖ File tr√πng kh·ªõp (text)";
                    verifyResult.style.color = "green";
                } else {
                    verifyResult.textContent = "‚ùå File kh√¥ng kh·ªõp (text)";
                    verifyResult.style.color = "red";
                }
            }
        };
        reader.readAsArrayBuffer(selectedFile);
    });
</script>
</body>
</html>
